rule  Dev_sigma_malicious_powerview_powershell_commandlets {
 meta:
    author = "Bhabesh Raj"
    description = "Detects Commandlet names from PowerView of PowerSploit exploitation framework Author: Bhabesh Raj."
    reference = ""
    version = "0.01"
    created = "2021/05/18"
    product = "windows"
    service = "powershell"
    mitre = "execution, t1059.001"

  events:
($selection.metadata.product_event_type = "4104" and ($selection.target.process.command_line = "Export-PowerViewCSV" or $selection.target.process.command_line = "Resolve-IPAddress" or $selection.target.process.command_line = "ConvertTo-SID" or $selection.target.process.command_line = "Convert-ADName" or $selection.target.process.command_line = "ConvertFrom-UACValue" or $selection.target.process.command_line = "Add-RemoteConnection" or $selection.target.process.command_line = "Remove-RemoteConnection" or $selection.target.process.command_line = "Invoke-UserImpersonation" or $selection.target.process.command_line = "Invoke-RevertToSelf" or $selection.target.process.command_line = "Get-DomainSPNTicket" or $selection.target.process.command_line = "Invoke-Kerberoast" or $selection.target.process.command_line = "Get-PathAcl" or $selection.target.process.command_line = "Get-DomainDNSZone" or $selection.target.process.command_line = "Get-DomainDNSRecord" or $selection.target.process.command_line = "Get-Domain" or $selection.target.process.command_line = "Get-DomainController" or $selection.target.process.command_line = "Get-Forest" or $selection.target.process.command_line = "Get-ForestDomain" or $selection.target.process.command_line = "Get-ForestGlobalCatalog" or $selection.target.process.command_line = "Find-DomainObjectPropertyOutlier-" or $selection.target.process.command_line = "Get-DomainUser" or $selection.target.process.command_line = "New-DomainUser" or $selection.target.process.command_line = "Set-DomainUserPassword" or $selection.target.process.command_line = "Get-DomainUserEvent" or $selection.target.process.command_line = "Get-DomainComputer" or $selection.target.process.command_line = "Get-DomainObject" or $selection.target.process.command_line = "Set-DomainObject" or $selection.target.process.command_line = "Get-DomainObjectAcl" or $selection.target.process.command_line = "Add-DomainObjectAcl" or $selection.target.process.command_line = "Find-InterestingDomainAcl" or $selection.target.process.command_line = "Get-DomainOU" or $selection.target.process.command_line = "Get-DomainSite" or $selection.target.process.command_line = "Get-DomainSubnet" or $selection.target.process.command_line = "Get-DomainSID" or $selection.target.process.command_line = "Get-DomainGroup" or $selection.target.process.command_line = "New-DomainGroup" or $selection.target.process.command_line = "Get-DomainManagedSecurityGroup" or $selection.target.process.command_line = "Get-DomainGroupMember" or $selection.target.process.command_line = "Add-DomainGroupMember" or $selection.target.process.command_line = "Get-DomainFileServer" or $selection.target.process.command_line = "Get-DomainDFSShare" or $selection.target.process.command_line = "Get-DomainGPO" or $selection.target.process.command_line = "Get-DomainGPOLocalGroup" or $selection.target.process.command_line = "Get-DomainGPOUserLocalGroupMapping" or $selection.target.process.command_line = "Get-DomainGPOComputerLocalGroupMapping" or $selection.target.process.command_line = "Get-DomainPolicy" or $selection.target.process.command_line = "Get-NetLocalGroup" or $selection.target.process.command_line = "Get-NetLocalGroupMember" or $selection.target.process.command_line = "Get-NetShare" or $selection.target.process.command_line = "Get-NetLoggedon" or $selection.target.process.command_line = "Get-NetSession" or $selection.target.process.command_line = "Get-RegLoggedOn" or $selection.target.process.command_line = "Get-NetRDPSession" or $selection.target.process.command_line = "Test-AdminAccess" or $selection.target.process.command_line = "Get-NetComputerSiteName" or $selection.target.process.command_line = "Get-WMIRegProxy" or $selection.target.process.command_line = "Get-WMIRegLastLoggedOn" or $selection.target.process.command_line = "Get-WMIRegCachedRDPConnection" or $selection.target.process.command_line = "Get-WMIRegMountedDrive" or $selection.target.process.command_line = "Get-WMIProcess" or $selection.target.process.command_line = "Find-InterestingFile" or $selection.target.process.command_line = "Find-DomainUserLocation" or $selection.target.process.command_line = "Find-DomainProcess" or $selection.target.process.command_line = "Find-DomainUserEvent" or $selection.target.process.command_line = "Find-DomainShare" or $selection.target.process.command_line = "Find-InterestingDomainShareFile" or $selection.target.process.command_line = "Find-LocalAdminAccess" or $selection.target.process.command_line = "Find-DomainLocalGroupMember" or $selection.target.process.command_line = "Get-DomainTrust" or $selection.target.process.command_line = "Get-ForestTrust" or $selection.target.process.command_line = "Get-DomainForeignUser" or $selection.target.process.command_line = "Get-DomainForeignGroupMember" or $selection.target.process.command_line = "Get-DomainTrustMapping"))

  condition:
    $selection
}
