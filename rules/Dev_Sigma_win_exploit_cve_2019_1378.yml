rule  Dev_sigma_exploiting_setupcompletecmd_cve20191378 {
 meta:
    author = "Florian Roth, oscd.community, Jonhnathan Ribeiro"
    description = "Detects exploitation attempt of privilege escalation vulnerability via SetupComplete.cmd and PartnerSetupComplete.cmd described in CVE-2019-1378 Author: Florian Roth, oscd.community, Jonhnathan Ribeiro."
    reference = ""
    version = "0.01"
    created = "2019/11/15"
    category = "process_creation"
    product = "windows"
    mitre = "privilege_escalation, t1068, execution, t1059.003, t1059, t1574"

  events:
((re.regex($selection.src.process.command_line, `.*\\cmd\.exe.*`) and re.regex($selection.src.process.command_line, `.*/c.*`) and re.regex($selection.src.process.command_line, `.*C:\\Windows\\Setup\\Scripts\\.*`) and (re.regex($selection.src.process.command_line, `.*SetupComplete\.cmd`) or re.regex($selection.src.process.command_line, `.*PartnerSetupComplete\.cmd`))) and not ((re.regex($selection.target.process.file.full_path, `C:\\Windows\\System32\\.*`) or re.regex($selection.target.process.file.full_path, `C:\\Windows\\SysWOW64\\.*`) or re.regex($selection.target.process.file.full_path, `C:\\Windows\\WinSxS\\.*`) or re.regex($selection.target.process.file.full_path, `C:\\Windows\\Setup\\.*`))))

  condition:
    $selection
}
