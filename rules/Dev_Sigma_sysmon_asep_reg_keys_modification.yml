rule  Dev_sigma_autorun_keys_modification {
 meta:
    author = "Victor Sergeev, Daniil Yugoslavskiy, Gleb Sukhodolskiy, Timur Zinniatullin, oscd.community"
    description = "Detects modification of autostart extensibility point (ASEP) in registry. Author: Victor Sergeev, Daniil Yugoslavskiy, Gleb Sukhodolskiy, Timur Zinniatullin, oscd.community."
    reference = ""
    version = "0.01"
    created = "2019/10/25"
    category = "registry_event"
    product = "windows"
    mitre = "persistence, t1547.001, t1060"

  events:
(((((((((((((re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows CE Services\\AutoStart.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Wow6432Node\\Microsoft\\Command Processor\\Autorun.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Active Setup\\Installed Components.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnDisconnect.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnConnect.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SYSTEM\\Setup\\CmdLine.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Microsoft\\Ctf\\LangBarAddin.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Microsoft\\Command Processor\\Autorun.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Classes\\Protocols\\Handler.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Classes\\Protocols\\Filter.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Classes\\Htmlfile\\Shell\\Open\\Command\\\(Default\).*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Environment\\UserInitMprLogonScript.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\Scrnsave\.exe.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Microsoft\\Internet Explorer\\UrlSearchHooks.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Microsoft\\Internet Explorer\\Desktop\\Components.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Classes\\Clsid\\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\\Inprocserver32.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Control Panel\\Desktop\\Scrnsave\.exe.*`)) or (re.regex($main_selection.target.registry.registry_key, `.*\\System\\CurrentControlSet\\Control\\Session Manager.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\SetupExecute.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\S0InitialCommand.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\KnownDlls.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Execute.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\BootExecute.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\AppCertDlls.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\ShellServiceObjectDelayLoad.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Run.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Policies\\System\\Shell.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Policies\\Explorer\\Run.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Group Policy\\Scripts\\Startup.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Group Policy\\Scripts\\Shutdown.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Group Policy\\Scripts\\Logon.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Group Policy\\Scripts\\Logoff.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\ShellServiceObjects.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\ShellIconOverlayIdentifiers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\ShellExecuteHooks.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\SharedTaskScheduler.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\Browser Helper Objects.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Authentication\\PLAP Providers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Authentication\\Credential Providers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Authentication\\Credential Provider Filters.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\Winlogon\\VmApplet.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Winlogon\\Userinit.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Winlogon\\Taskman.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Winlogon\\Shell.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Winlogon\\GpExtensions.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Winlogon\\AppSetup.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Winlogon\\AlternateShells\\AvailableShells.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Windows\\IconServiceLib.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Windows\\Appinit_Dlls.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Image File Execution Options.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Font Drivers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Drivers32.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Windows\\Run.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Windows\\Load.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\ShellServiceObjectDelayLoad.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Run.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\ShellServiceObjects.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\ShellIconOverlayIdentifiers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\ShellExecuteHooks.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\SharedTaskScheduler.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer\\Browser Helper Objects.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\Windows\\Appinit_Dlls.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Image File Execution Options.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Drivers32.*`)))) or ((re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Wow6432Node\\Microsoft\\Office.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Microsoft\\Office.*`)) and (re.regex($main_selection.target.registry.registry_key, `.*\\Word\\Addins.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\PowerPoint\\Addins.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Outlook\\Addins.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Onenote\\Addins.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Excel\\Addins.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Access\\Addins.*`) or re.regex($main_selection.target.registry.registry_key, `.*test\\Special\\Perf.*`)))) or ((re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Wow6432Node\\Microsoft\\Internet Explorer.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Microsoft\\Internet Explorer.*`)) and (re.regex($main_selection.target.registry.registry_key, `.*\\Toolbar.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Extensions.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Explorer Bars.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Wow6432Node\\Classes.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\Folder\\ShellEx\\ExtShellFolderViews.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Folder\\ShellEx\\DragDropHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Folder\\ShellEx\\ColumnHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Directory\\Shellex\\DragDropHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Directory\\Shellex\\CopyHookHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\CLSID\\{AC757296-3522-4E11-9862-C17BE5A1767E}\\Instance.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\CLSID\\{ABE3B9A4-257D-4B97-BD1A-294AF496222E}\\Instance.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\CLSID\\{7ED96837-96F0-4812-B211-F13C24117ED3}\\Instance.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\CLSID\\{083863F1-70DE-11d0-BD40-00A0C911CE86}\\Instance.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\AllFileSystemObjects\\ShellEx\\DragDropHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\ShellEx\\PropertySheetHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\ShellEx\\ContextMenuHandlers.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Classes.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\Folder\\ShellEx\\ExtShellFolderViews.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Folder\\ShellEx\\DragDropHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Folder\\Shellex\\ColumnHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Filter.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Exefile\\Shell\\Open\\Command\\\(Default\).*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Directory\\Shellex\\DragDropHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Directory\\Shellex\\CopyHookHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\CLSID\\{AC757296-3522-4E11-9862-C17BE5A1767E}\\Instance.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\CLSID\\{ABE3B9A4-257D-4B97-BD1A-294AF496222E}\\Instance.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\CLSID\\{7ED96837-96F0-4812-B211-F13C24117ED3}\\Instance.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\CLSID\\{083863F1-70DE-11d0-BD40-00A0C911CE86}\\Instance.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Classes\\AllFileSystemObjects\\ShellEx\\DragDropHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\\.exe.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\\.cmd.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\ShellEx\\PropertySheetHandlers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\ShellEx\\ContextMenuHandlers.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\Software\\Policies\\Microsoft\\Windows\\System\\Scripts.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\Startup.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Shutdown.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Logon.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Logoff.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\System\\CurrentControlSet\\Services\\WinSock2\\Parameters.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\Protocol_Catalog9\\Catalog_Entries.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\NameSpace_Catalog5\\Catalog_Entries.*`)))) or (re.regex($main_selection.target.registry.registry_key, `.*\\SYSTEM\\CurrentControlSet\\Control.*`) and (re.regex($main_selection.target.registry.registry_key, `.*\\Terminal Server\\WinStations\\RDP-Tcp\\InitialProgram.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Terminal Server\\Wds\\rdpwd\\StartupPrograms.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SecurityProviders\\SecurityProviders.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\SafeBoot\\AlternateShell.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Print\\Providers.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Print\\Monitors.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\NetworkProvider\\Order.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Lsa\\Notification Packages.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\Lsa\\Authentication Packages.*`) or re.regex($main_selection.target.registry.registry_key, `.*\\BootVerificationProgram\\ImagePath.*`))))

  condition:
    $main_selection
}
