rule  Dev_sigma_generic_password_dumper_activity_on_lsass {
 meta:
    author = "Roberto Rodriguez, Teymur Kheirkhabarov, Dimitrios Slamaris, Mark Russinovich, Aleksey Potapov, oscd.community (update)"
    description = "Detects process handle on LSASS process with certain access mask Author: Roberto Rodriguez, Teymur Kheirkhabarov, Dimitrios Slamaris, Mark Russinovich, Aleksey Potapov, oscd.community (update)."
    reference = ""
    version = "0.01"
    created = "2019/11/01"
    product = "windows"
    service = "security"
    mitre = "credential_access, t1003, car.2019-04-004, t1003.001"

  events:
(($selection_1.metadata.product_event_type = "4656" and (re.regex($selection_1.target.file.full_path, `.*\\lsass\.exe`) or re.regex($selection_1.target.registry.registry_value_data, `.*\\lsass\.exe`)) and (re.regex($selection_1.target.process.access_mask, `.*0x40.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1400.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1000.*`) or re.regex($selection_1.target.process.access_mask, `.*0x100000.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1410.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1010.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1438.*`) or re.regex($selection_1.target.process.access_mask, `.*0x143a.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1418.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1f0fff.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1f1fff.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1f2fff.*`) or re.regex($selection_1.target.process.access_mask, `.*0x1f3fff.*`))) or ((($selection_1.metadata.product_event_type = "4663" and (re.regex($selection_1.target.file.full_path, `.*\\lsass\.exe`) or re.regex($selection_1.target.registry.registry_value_data, `.*\\lsass\.exe`)) and (re.regex($selection_1.AccessList, `.*4484.*`) or re.regex($selection_1.AccessList, `.*4416.*`))) and not ((re.regex($selection_1.target.process.file.full_path, `.*\\wmiprvse\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\taskmgr\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\procexp64\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\procexp\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\lsm\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\csrss\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\wininit\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\vmtoolsd\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\minionhost\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\VsTskMgr\.exe`) or re.regex($selection_1.target.process.file.full_path, `.*\\thor64\.exe`)) and (re.regex($selection_1.target.process.file.full_path, `C:\\Windows\\System32\\.*`) or re.regex($selection_1.target.process.file.full_path, `C:\\Windows\\SysWow64\\.*`) or re.regex($selection_1.target.process.file.full_path, `C:\\Windows\\SysNative\\.*`) or re.regex($selection_1.target.process.file.full_path, `C:\\Program Files\\.*`) or re.regex($selection_1.target.process.file.full_path, `C:\\Windows\\Temp\\asgard2-agent\\.*`)))) and not (re.regex($selection_1.target.process.file.full_path, `C:\\Program Files.*`))))

  condition:
    $selection_1
}
